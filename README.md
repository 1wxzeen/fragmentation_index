# Wrist‑accelerometry Fragmentation Index (FI) pipeline #

This repo shows how to compute "movement fragmentation" (Wanigatunga 2019) from raw 80 Hz ActiGraph `.sensor.csv` files.

Two files:
- Full pipeline (fi_pipeline.r): loads an entire week of hourly files, outputs weekly FI; exceeds 16gb memory when running
- mini pipeline (f_pipeline.mini.r): loads the first N hourly files (set to 24 ≈ 1 day) for proof of concenpt

The mini script contains the ability to specify the number of hourly files, and so the two files are otherwise identical

# File structure #

DS_FI/
---fi_pipeline.r
---fi_pipeline.mini.r
---nhanes_raw/
    ---NNYFS/
        ---<participant ID folders containing .sensor.csv files>/
            ---inside the <participant ID> folders, the frag_index_<id>.txt and counts_<id>.csv files will be generated by default by the scripts 

# Prerequisites #

in R console:

install.packages(c("data.table", "ggplot2"))
install.packages(
  "https://epi.grants.cancer.gov/physical/NHANES.RAW80Hz_0.0.3.tar.gz",
  repos = NULL, type = "source"
)

install.packages("agcounts")

# Using the scripts #

setwd("~/path/to/DS_FI")
source("fi_pipeline.r") or source("fi_pipeline.mini.r") 

- may need >16gb RAM for a full week (at least I encountered a vector memory limit error when trying to run it)

# edit only these two lines to pick a participant
cycle <- "NNYFS" # or "2011-12"
id    <- "73557" # folder under nhanes_raw/<cycle>/

# To change different active cut-point, edit:
cut_pt <- 10

#For mini.r:
N_demo <- 24 #Can be changed to 48

# Outputs #

As explained earlier, Outputs (saved inside each <ID>_raw folder). A message in the console will also explain where they can be found (along with outputting the calculated fragmentation index for the participant)

- counts_<ID>.csv: 
    One row per minute. 
    Columns: Time, VM (ActiGraph counts) 
    Active (1 = counts ≥ 10)
- frag_index_<ID>.txt:	
    Single number fragmentation index (ie .02 or .0443)
- qc_<ID>.png:
    Step plot of Active (1/0) vs. time
    (this feature's functionality currently does not work for me as I don't see the generated png in my directory despite it saying that it was generated in the right spot; will debug for a future patch)
The mini script jut appends "_mini" at the end of each file name